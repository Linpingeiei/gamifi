<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Mitr', sans-serif;
            background-color: #f0f4f8; /* Soft Blue/Gray */
        }
        .soft-bg-1 { background-color: #e6f3ff; } /* Soft Blue */
        .soft-bg-2 { background-color: #e0f8f0; } /* Soft Green */
        .soft-bg-3 { background-color: #fff9e6; } /* Soft Yellow */
        .soft-bg-4 { background-color: #fde2e4; } /* Soft Pink */
        .tab-active {
            background-color: #4a90e2; /* Brighter Blue for active tab */
            color: white;
        }
        .btn-primary {
            background-color: #4a90e2;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #357abd;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-animation: fadeIn 0.3s;
            animation: fadeIn 0.3s;
        }
        .modal-content {
            -webkit-animation: slideIn 0.3s;
            animation: slideIn 0.3s;
        }
        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @-webkit-keyframes slideIn { from {transform: translateY(-50px)} to {transform: translateY(0)} }
        @keyframes slideIn { from {transform: translateY(-50px)} to {transform: translateY(0)} }
    </style>
     <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body class="antialiased">

    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center soft-bg-1 px-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üë®‚Äçüè´ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h1>
            <p class="text-gray-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <form id="login-form">
                <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg shadow-md">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </form>
            <button id="view-dashboard-btn" class="mt-4 text-blue-600 hover:underline">‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">‚ú® ‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‚ú®</h1>
            <div>
                <button id="goto-redeem-btn-from-dash" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2"><i class="fas fa-gift mr-2"></i>‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                <button id="goto-admin-btn-from-dash" class="btn-primary px-4 py-2 rounded-lg font-semibold"><i class="fas fa-user-shield mr-2"></i>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
            </div>
        </header>
        <main class="p-4 md:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div id="leaderboard-container" class="lg:col-span-1"></div>
                <div id="point-criteria-display" class="lg:col-span-2"></div>
            </div>

            <div id="dashboard-tabs" class="flex flex-wrap border-b border-gray-200 mb-4"></div>
            
            <div class="bg-white p-4 rounded-xl shadow-md">
                <table class="w-full text-left">
                    <thead class="border-b-2 border-gray-200">
                        <tr>
                            <th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</th>
                            <th class="p-3 text-center">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° üåü</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-student-list"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Admin Page -->
    <div id="admin-page" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">üõ†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h1>
            <div>
                 <button id="goto-redeem-btn-from-admin" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2"><i class="fas fa-gift mr-2"></i>‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                 <button id="fetch-gsheet-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md mr-2"><i class="fas fa-cloud-download-alt mr-2"></i>‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheet</button>
                 <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-sign-out-alt mr-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </header>
        <main class="p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="soft-bg-2 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <div id="admin-tabs" class="flex flex-wrap border-b border-gray-200 mb-4"></div>
                <div class="bg-white p-4 rounded-xl shadow-md">
                    <table class="w-full text-left">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                <th class="p-3">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô)</th>
                                <th class="p-3 text-center">‡πÅ‡∏ï‡πâ‡∏° üåü</th>
                                <th class="p-3 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="admin-student-list"></tbody>
                    </table>
                </div>
            </div>
            <div class="soft-bg-3 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold mb-4">üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                <form id="add-student-form">
                    <div class="mb-4">
                        <label for="new-student-room" class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
                        <select id="new-student-room" class="w-full p-3 border border-gray-300 rounded-lg" required></select>
                    </div>
                    <div class="mb-4">
                        <label for="new-student-id" class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label>
                        <input type="number" id="new-student-id" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1" required>
                    </div>
                    <div class="mb-4">
                        <label for="new-student-name" class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="new-student-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required>
                    </div>
                    <div class="mb-4">
                        <label for="new-student-nickname" class="block text-gray-700 font-semibold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="new-student-nickname" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå">
                    </div>
                    <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg shadow-md">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Redeem Page -->
    <div id="redeem-page" class="hidden">
        <header class="bg-white shadow-md p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">üéÅ ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h1>
            <button id="back-from-redeem-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md"><i class="fas fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö</button>
        </header>
        <main class="p-4 md:p-6">
            <div class="soft-bg-4 p-6 rounded-2xl shadow-lg max-w-4xl mx-auto">
                <h2 class="text-xl font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h2>
                <div class="mb-6">
                    <label for="redeem-student-selector" class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <select id="redeem-student-selector" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div id="rewards-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Rewards will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="history-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:w-1-2 lg:w-1-3 mx-auto mt-20 p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 id="history-modal-title" class="text-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
                <button id="close-history-modal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="history-modal-body" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="manage-points-modal" class="modal">
        <div class="modal-content bg-white w-11/12 md:w-1-2 lg:w-1-3 mx-auto mt-20 p-6 rounded-2xl shadow-lg">
             <div class="flex justify-between items-center mb-4">
                <h2 id="manage-modal-title" class="text-2xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
                <button id="close-manage-modal" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="manage-points-form">
                 <input type="hidden" id="manage-student-key">
                 <div class="mb-4">
                    <label for="points-criteria" class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
                    <select id="points-criteria" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div id="custom-reason-container" class="mb-4 hidden">
                    <label for="points-reason" class="block text-gray-700 font-semibold mb-2">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á)</label>
                    <input type="text" id="points-reason" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©">
                </div>
                 <div class="mb-4">
                    <label for="points-value" class="block text-gray-700 font-semibold mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏•‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î)</label>
                    <input type="number" id="points-value" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10 ‡∏´‡∏£‡∏∑‡∏≠ -5" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-3 rounded-lg shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8xex4zJh-PHx2ovRQwz0YkQ0l3y2m4oUONSY87dh9W4t5Ma2vqzIf0H6asvnwduib/exec';
            const LOCAL_STORAGE_KEY = 'studentScoreData';

            const pointCriteria = [
                { reason: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', points: 10 },
                { reason: '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤', points: 5 },
                { reason: '‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', points: 5 },
                { reason: '‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô', points: 3 },
                { reason: '‡∏°‡∏≤‡∏™‡∏≤‡∏¢', points: -5 },
                { reason: '‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤', points: -5 },
                { reason: '‡∏•‡∏∑‡∏°‡πÅ‡∏ö‡∏ö‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î', points: -2 },
                { reason: '‡∏Ñ‡∏∏‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', points: -3 }
            ];

            const rewards = [
                { name: 'üñäÔ∏è ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤', cost: 30 },
                { name: 'üß¥ ‡∏•‡∏¥‡∏Ñ‡∏ß‡∏¥‡∏î', cost: 40 },
                { name: 'üìñ ‡∏™‡∏°‡∏∏‡∏î', cost: 60 },
                { name: 'üç¨ ‡∏Ç‡∏ô‡∏°', cost: 100 },
                { name: 'ü•§ ‡∏ô‡πâ‡∏≥‡∏´‡∏ß‡∏≤‡∏ô', cost: 100 },
                { name: 'üéâ ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏ü‡∏£‡∏µ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', cost: 200 }
            ];

            const loginPage = document.getElementById('login-page');
            const dashboardPage = document.getElementById('dashboard-page');
            const adminPage = document.getElementById('admin-page');
            const redeemPage = document.getElementById('redeem-page');

            let studentData = {};
            let activeTab = '';
            let isAuthenticated = false;
            let lastPage = dashboardPage; // To track where to go back to from redeem page

            const saveData = () => {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(studentData));
            };

            const loadData = () => {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                studentData = data ? JSON.parse(data) : {};
                if (Object.keys(studentData).length > 0) {
                    activeTab = studentData['‡∏õ.4/2'] ? '‡∏õ.4/2' : Object.keys(studentData)[0];
                }
            };
            
            const showPage = (page) => {
                loginPage.classList.add('hidden');
                dashboardPage.classList.add('hidden');
                adminPage.classList.add('hidden');
                redeemPage.classList.add('hidden');
                page.classList.remove('hidden');
                if (page === dashboardPage || page === adminPage) {
                    lastPage = page;
                }
            };

            const render = () => {
                renderLeaderboard();
                renderTabs('dashboard-tabs');
                renderTabs('admin-tabs');
                renderStudentList('dashboard-student-list', false);
                renderStudentList('admin-student-list', true);
                populateRoomSelector();
                renderPointCriteria();
                renderRedeemPage();
            };

            const renderLeaderboard = () => {
                const container = document.getElementById('leaderboard-container');
                if (!container) return;
                let allStudents = [];
                Object.keys(studentData).forEach(room => {
                    studentData[room].forEach(student => {
                        const totalPoints = student.history.reduce((sum, item) => sum + item.points, 0);
                        allStudents.push({ ...student, roomName: room, totalPoints });
                    });
                });

                const topStudents = allStudents.sort((a, b) => b.totalPoints - a.totalPoints).slice(0, 5);
                let leaderboardHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg h-full"><h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-trophy text-yellow-500 mr-3"></i> 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2><ol class="space-y-4">`;
                if (topStudents.length === 0 || topStudents.every(s => s.totalPoints === 0)) {
                    leaderboardHTML += `<li class="text-center text-gray-500 py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</li>`;
                } else {
                    topStudents.forEach((student, index) => {
                        const rankColors = ['text-yellow-400', 'text-gray-400', 'text-orange-400'];
                        const icon = index < 3 ? `<i class="fas fa-medal ${rankColors[index]}"></i>` : `<span class="font-bold text-gray-500">${index + 1}</span>`;
                        const nicknameDisplay = student.nickname ? `(${student.nickname})` : '';
                        leaderboardHTML += `<li class="flex items-center"><div class="w-8 text-center text-2xl">${icon}</div><div class="ml-3 flex-grow"><p class="font-semibold text-gray-800">${student.name} ${nicknameDisplay}</p><p class="text-sm text-gray-500">‡∏´‡πâ‡∏≠‡∏á ${student.roomName}</p></div><div class="font-bold text-lg ${student.totalPoints >= 0 ? 'text-green-600' : 'text-red-600'}">${student.totalPoints}</div></li>`;
                    });
                }
                leaderboardHTML += `</ol></div>`;
                container.innerHTML = leaderboardHTML;
            };

            const renderPointCriteria = () => {
                const container = document.getElementById('point-criteria-display');
                if (!container) return;
                const positiveCriteria = pointCriteria.filter(c => c.points > 0);
                const negativeCriteria = pointCriteria.filter(c => c.points < 0);
                container.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg h-full"><h2 class="text-xl font-bold text-gray-800 mb-4">üìú ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold text-green-600 mb-2">‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°</h3><ul class="space-y-2">${positiveCriteria.map(c => `<li class="flex justify-between items-center text-gray-700"><span>${c.reason}</span><span class="font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full text-sm">+${c.points}</span></li>`).join('')}</ul></div><div><h3 class="font-semibold text-red-600 mb-2">‚ùå ‡∏Å‡∏≤‡∏£‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°</h3><ul class="space-y-2">${negativeCriteria.map(c => `<li class="flex justify-between items-center text-gray-700"><span>${c.reason}</span><span class="font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full text-sm">${c.points}</span></li>`).join('')}</ul></div></div></div>`;
            };

            const renderTabs = (containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                Object.keys(studentData).sort().forEach(room => {
                    const tab = document.createElement('button');
                    tab.textContent = `‡∏´‡πâ‡∏≠‡∏á ${room}`;
                    tab.className = `px-4 py-2 rounded-t-lg font-semibold mr-1 ${room === activeTab ? 'tab-active' : 'bg-gray-200 hover:bg-gray-300'}`;
                    tab.onclick = () => { activeTab = room; render(); };
                    container.appendChild(tab);
                });
            };

            const renderStudentList = (containerId, isAdmin) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                let studentsToRender = [];
                if (studentData[activeTab]) {
                    studentData[activeTab].forEach((student, index) => {
                        studentsToRender.push({ ...student, key: `${activeTab}-${index}` });
                    });
                }
                const sortedStudents = studentsToRender.sort((a, b) => a.id - b.id);
                if (sortedStudents.length === 0) {
                    const colSpan = isAdmin ? 4 : 3;
                    container.innerHTML = `<tr><td colspan="${colSpan}" class="text-center p-6 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`;
                    return;
                }
                sortedStudents.forEach((student) => {
                    const totalPoints = student.history.reduce((sum, item) => sum + item.points, 0);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-100 cursor-pointer';
                    const nicknameDisplay = student.nickname ? ` (${student.nickname})` : '';
                    let adminButtons = '';
                    if (isAdmin) {
                        adminButtons = `<td class="p-3 text-center"><button data-key="${student.key}" class="manage-points-btn bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button></td>`;
                    } else {
                        row.dataset.key = student.key;
                        row.classList.add('view-history-btn');
                    }
                    row.innerHTML = `<td class="p-3">${student.id}</td><td class="p-3 font-medium">${student.name}${nicknameDisplay}</td><td class="p-3 text-center font-bold text-lg ${totalPoints >= 0 ? 'text-green-600' : 'text-red-600'}">${totalPoints}</td>${adminButtons}`;
                    container.appendChild(row);
                });
            };
            
            const populateRoomSelector = () => {
                const selector = document.getElementById('new-student-room');
                selector.innerHTML = '';
                Object.keys(studentData).forEach(room => {
                    const option = document.createElement('option');
                    option.value = room;
                    option.textContent = `‡∏´‡πâ‡∏≠‡∏á ${room}`;
                    selector.appendChild(option);
                });
            };

            const showHistoryModal = (studentKey) => {
                const [room, index] = studentKey.split('-');
                const student = studentData[room][index];
                document.getElementById('history-modal-title').textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${student.name}`;
                const body = document.getElementById('history-modal-body');
                body.innerHTML = '';
                if (student.history.length === 0) {
                    body.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>';
                } else {
                    const list = document.createElement('ul');
                    [...student.history].reverse().forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center border-b p-3';
                        const pointsClass = item.points > 0 ? 'text-green-600' : 'text-red-600';
                        li.innerHTML = `<div><p class="font-semibold">${item.reason}</p><p class="text-sm text-gray-500">${new Date(item.date).toLocaleString('th-TH')}</p></div><span class="font-bold text-lg ${pointsClass}">${item.points > 0 ? '+' : ''}${item.points}</span>`;
                        list.appendChild(li);
                    });
                    body.appendChild(list);
                }
                document.getElementById('history-modal').style.display = 'flex';
            };

            const populateCriteriaSelector = () => {
                const selector = document.getElementById('points-criteria');
                selector.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå --</option>';
                pointCriteria.forEach((item, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${item.reason} (${item.points > 0 ? '+' : ''}${item.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)`;
                    selector.appendChild(option);
                });
                const otherOption = document.createElement('option');
                otherOption.value = 'custom';
                otherOption.textContent = '‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á)';
                selector.appendChild(otherOption);
            };

            const showManagePointsModal = (studentKey) => {
                const [room, index] = studentKey.split('-');
                const student = studentData[room][index];
                document.getElementById('manage-modal-title').textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${student.name}`;
                document.getElementById('manage-student-key').value = studentKey;
                document.getElementById('manage-points-form').reset();
                document.getElementById('custom-reason-container').classList.add('hidden');
                populateCriteriaSelector();
                document.getElementById('manage-points-modal').style.display = 'flex';
            };
            
            const renderRedeemPage = () => {
                const studentSelector = document.getElementById('redeem-student-selector');
                const rewardsContainer = document.getElementById('rewards-list');
                const selectedStudentKey = studentSelector.value;
                studentSelector.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
                rewardsContainer.innerHTML = '';
                let allStudents = [];
                Object.keys(studentData).forEach(room => {
                    studentData[room].forEach((student, index) => {
                        allStudents.push({ ...student, roomName: room, key: `${room}-${index}` });
                    });
                });
                allStudents.sort((a,b) => a.name.localeCompare(b.name, 'th')).forEach(student => {
                    const totalPoints = student.history.reduce((sum, item) => sum + item.points, 0);
                    const option = document.createElement('option');
                    option.value = student.key;
                    option.textContent = `${student.name} (‡∏´‡πâ‡∏≠‡∏á ${student.roomName}) - ${totalPoints} ‡πÅ‡∏ï‡πâ‡∏°`;
                    studentSelector.appendChild(option);
                });
                studentSelector.value = selectedStudentKey;

                let studentPoints = -1;
                if (selectedStudentKey) {
                    const [room, index] = selectedStudentKey.split('-');
                    const student = studentData[room][index];
                    studentPoints = student.history.reduce((sum, item) => sum + item.points, 0);
                }
                
                rewards.forEach(reward => {
                    const canAfford = studentPoints >= reward.cost;
                    const rewardEl = document.createElement('div');
                    rewardEl.className = `bg-white p-4 rounded-lg shadow-md flex flex-col justify-between items-center text-center transition-opacity ${selectedStudentKey ? 'opacity-100' : 'opacity-50'}`;
                    rewardEl.innerHTML = `
                        <div class="text-3xl mb-2">${reward.name.split(' ')[0]}</div>
                        <div>
                            <p class="font-bold text-lg">${reward.name.split(' ').slice(1).join(' ')}</p>
                            <p class="text-yellow-600 font-semibold">${reward.cost} ‡πÅ‡∏ï‡πâ‡∏°</p>
                        </div>
                        <button data-cost="${reward.cost}" data-name="${reward.name}" class="redeem-btn mt-3 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 disabled:bg-gray-400 disabled:cursor-not-allowed w-full" ${!canAfford ? 'disabled' : ''}>‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
                    `;
                    rewardsContainer.appendChild(rewardEl);
                });
            };
            
            window.handleSheetData = (data) => {
                Swal.close();
                let newStudentData = {};
                for (const room in data) {
                    if (!newStudentData[room]) newStudentData[room] = [];
                    data[room].forEach(sheetStudent => {
                        const existingStudent = studentData[room] ? studentData[room].find(s => s.id === sheetStudent.id) : null;
                        if (existingStudent) {
                             newStudentData[room].push({ ...existingStudent, name: sheetStudent.name, nickname: sheetStudent.nickname });
                        } else {
                             newStudentData[room].push({ id: sheetStudent.id, name: sheetStudent.name, nickname: sheetStudent.nickname, history: [] });
                        }
                    });
                }
                studentData = newStudentData;
                if (!activeTab || !studentData[activeTab]) {
                    activeTab = studentData['‡∏õ.4/2'] ? '‡∏õ.4/2' : Object.keys(studentData)[0];
                }
                saveData();
                render();
                Swal.fire({ icon: 'success', title: '‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß', timer: 1500, showConfirmButton: false });
            };

            const fetchFromGoogleSheet = () => {
                if (SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_DEPLOYMENT_URL') {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô', 'error');
                    return;
                }
                 Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
                const script = document.createElement('script');
                script.src = `${SCRIPT_URL}?callback=handleSheetData&t=${new Date().getTime()}`;
                document.body.appendChild(script);
                script.onload = () => document.body.removeChild(script);
                script.onerror = () => { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS', 'error'); }
            };
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById('password').value === 'Chompoo24') {
                    isAuthenticated = true;
                    showPage(adminPage);
                } else {
                    Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                }
            });
            
            document.getElementById('view-dashboard-btn').addEventListener('click', () => showPage(dashboardPage));
            document.getElementById('goto-admin-btn-from-dash').addEventListener('click', () => { isAuthenticated ? showPage(adminPage) : showPage(loginPage); });
            document.getElementById('logout-btn').addEventListener('click', () => { isAuthenticated = false; document.getElementById('password').value = ''; showPage(loginPage); });
            document.getElementById('fetch-gsheet-btn').addEventListener('click', fetchFromGoogleSheet);

            document.getElementById('goto-redeem-btn-from-dash').addEventListener('click', () => showPage(redeemPage));
            document.getElementById('goto-redeem-btn-from-admin').addEventListener('click', () => showPage(redeemPage));
            document.getElementById('back-from-redeem-btn').addEventListener('click', () => showPage(lastPage));

            document.getElementById('redeem-student-selector').addEventListener('change', renderRedeemPage);
            
            document.getElementById('rewards-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('redeem-btn')) {
                    const studentKey = document.getElementById('redeem-student-selector').value;
                    if (!studentKey) {
                        Swal.fire('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '', 'warning');
                        return;
                    }
                    const rewardName = e.target.dataset.name;
                    const rewardCost = parseInt(e.target.dataset.cost);
                    const [room, index] = studentKey.split('-');
                    const student = studentData[room][index];
                    Swal.fire({
                        title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•?`,
                        html: `<b>${student.name}</b> ‡∏à‡∏∞‡πÉ‡∏ä‡πâ <b>${rewardCost}</b> ‡πÅ‡∏ï‡πâ‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏Å <b>${rewardName}</b>`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            studentData[room][index].history.push({ reason: `‡πÅ‡∏•‡∏Å‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${rewardName}`, points: -rewardCost, date: new Date().toISOString() });
                            saveData();
                            render();
                            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        }
                    })
                }
            });

            document.getElementById('add-student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const room = document.getElementById('new-student-room').value;
                const id = parseInt(document.getElementById('new-student-id').value);
                const name = document.getElementById('new-student-name').value;
                const nickname = document.getElementById('new-student-nickname').value;
                if (!room || !id || !name) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning'); return; }
                if (!studentData[room]) studentData[room] = [];
                if (studentData[room].some(s => s.id === id)) { Swal.fire('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥', `‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${id} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ${room} ‡πÅ‡∏•‡πâ‡∏ß`, 'error'); return; }
                studentData[room].push({ id, name, nickname, history: [] });
                saveData();
                render();
                e.target.reset();
                 Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            });
            
            document.getElementById('close-history-modal').onclick = () => document.getElementById('history-modal').style.display = 'none';
            document.getElementById('close-manage-modal').onclick = () => document.getElementById('manage-points-modal').style.display = 'none';
            
            document.body.addEventListener('click', (e) => {
                const historyBtn = e.target.closest('.view-history-btn');
                if (historyBtn) showHistoryModal(historyBtn.dataset.key);
                const manageBtn = e.target.closest('.manage-points-btn');
                if (manageBtn) showManagePointsModal(manageBtn.dataset.key);
            });

            document.getElementById('points-criteria').addEventListener('change', (e) => {
                const customReasonContainer = document.getElementById('custom-reason-container');
                const pointsValueInput = document.getElementById('points-value');
                const selectedValue = e.target.value;
                if (selectedValue === 'custom') {
                    customReasonContainer.classList.remove('hidden');
                    pointsValueInput.value = '';
                    pointsValueInput.readOnly = false;
                } else if (selectedValue !== '') {
                    customReasonContainer.classList.add('hidden');
                    const selectedCriterion = pointCriteria[parseInt(selectedValue)];
                    pointsValueInput.value = selectedCriterion.points;
                    pointsValueInput.readOnly = true;
                } else {
                    customReasonContainer.classList.add('hidden');
                    pointsValueInput.value = '';
                     pointsValueInput.readOnly = false;
                }
            });

            document.getElementById('manage-points-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const studentKey = document.getElementById('manage-student-key').value;
                const criteriaIndex = document.getElementById('points-criteria').value;
                const points = parseInt(document.getElementById('points-value').value);
                let reason = '';
                if (criteriaIndex === 'custom') {
                    reason = document.getElementById('points-reason').value;
                } else if (criteriaIndex !== '') {
                    reason = pointCriteria[parseInt(criteriaIndex)].reason;
                }
                if (!reason || isNaN(points)) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning'); return; }
                const [room, index] = studentKey.split('-');
                studentData[room][index].history.push({ reason, points, date: new Date().toISOString() });
                saveData();
                render();
                document.getElementById('manage-points-modal').style.display = 'none';
                Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', timer: 1500, showConfirmButton: false });
            });

            loadData();
            if (Object.keys(studentData).length > 0) {
                 showPage(dashboardPage);
            } else {
                 showPage(loginPage);
            }
            render();
        });
    </script>
</body>
</html>

